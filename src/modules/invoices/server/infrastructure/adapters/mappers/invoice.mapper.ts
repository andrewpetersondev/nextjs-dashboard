import "server-only";
import { isValid } from "date-fns";
import type {
  InvoiceEntity,
  InvoiceFormEntity,
  InvoiceServiceEntity,
} from "@/modules/invoices/domain/invoice.entity";
import { toInvoiceStatus } from "@/modules/invoices/domain/invoice-status.mapper";
import type { InvoiceRow } from "@/server-core/db/schema/invoices";
import {
  toCustomerId,
  toInvoiceId,
  toPeriod,
} from "@/shared/branding/converters/id-converters";
import { AppError } from "@/shared/errors/core/app-error.class";
import { Err, Ok } from "@/shared/result/result";
import type { Result } from "@/shared/result/result.types";

/**
 * Converts a date to the first day of the same month.
 * @param date - The input date
 * @returns A new Date object representing the first day of the month
 */
function toFirstDayOfMonthLocal(date: Date): Date {
  return new Date(date.getFullYear(), date.getMonth(), 1);
}

/**
 * Maps raw database row to branded Entity.
 */
export function rawDbToInvoiceEntity(
  row: InvoiceRow,
): Result<InvoiceEntity, AppError> {
  const statusResult = toInvoiceStatus(row.status);
  if (!statusResult.ok) {
    return Err(statusResult.error);
  }

  return Ok({
    amount: row.amount,
    customerId: toCustomerId(row.customerId),
    date: row.date,
    id: toInvoiceId(row.id),
    revenuePeriod: toPeriod(row.revenuePeriod),
    sensitiveData: row.sensitiveData,
    status: statusResult.value,
  });
}

/**
 * Maps branded InvoiceFormEntity to InvoiceServiceEntity.
 * Used for service layer operations.
 * @exclude
 * Excludes `id` since IDs are generated by the database.
 * @param formEntity - `InvoiceFormEntity` Branded form entity with valid Date object
 */
export function invoiceFormEntityToServiceEntity(
  formEntity: InvoiceFormEntity,
): Result<InvoiceServiceEntity, AppError> {
  if (!isValid(formEntity.date)) {
    return Err(
      new AppError("validation", {
        message: `Invalid date in form entity: ${formEntity.date}`,
      }),
    );
  }

  const derivedRevenuePeriod = toFirstDayOfMonthLocal(formEntity.date);

  return Ok({
    ...formEntity,
    revenuePeriod: toPeriod(derivedRevenuePeriod),
  });
}
